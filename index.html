<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }

      #detail-popup {
          padding: 2em 1em;
          border: 1px solid #ddd;
          border-radius: 0.8em;
          background-color: white;
          box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.3);
          display: none;
          position: absolute;
          right: 50px;
          top: 30px;
          width: 4in; height: 6in;
          font-family: sans-serif;
          color: #888;
      }

      #detail-popup th {
          color: purple;
          font-weight: normal;
      }

    </style>
    <script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgOeFbqElcSmR-zjycke6U8cvfS6E3x14&sensor=false"></script>
    <script type="text/javascript">
      // Data =================================================================
      var haveData = false;
      var courses = [];

      // Ask for data from the spreadsheet.
      function startDataLoad() {
          var spreadsheetKey = "0Asw-rVCOgjt8dFBndXdYTWVhaDJpaW5LbXl2QTliUWc";
          var wsId = "od6";
          load('http://spreadsheets.google.com/feeds/list'
               + '/' + spreadsheetKey + '/' + wsId + '/public/values' +
               '?alt=json-in-script&callback=onSpreadsheetData');
      }

      // This is called when the data loads from the spreadsheet.
      function onSpreadsheetData(json) {
          var fields = ["locationName", "address", "organization", "level", "startDate", "fee"];
          var lastRow = {};
          json.feed.entry.forEach(function (row) {
              var newRow = {};
              fields.forEach(function (name) {
                  var fieldName = name.toLowerCase();
                  if (fieldName == "address")
                      fieldName = "locationaddress";
                  console.log(name);
                  var value = row["gsx$" + fieldName].$t;
                  newRow[name] = value || lastRow[name];
              });
              lastRow = newRow;
              if (row.gsx$status.$t == 'Approved')
                  courses.push(newRow);
          });
          haveData = true;
          updateMap();
      }

      function showPopup(address) {
          var matches = courses.filter(function (course) { return course.address == address; });
          var c = matches[0]
          ko.applyBindings({
              organization: c.organization,
              address: address,
              coursesAtLocation: matches
          });
          document.getElementById("detail-popup").style.display = "block";
      }

      function hidePopup() {
          document.getElementById("detail-popup").style.display = "none";
      }

      // Map ==================================================================
      google.maps.visualRefresh = true;
      var map = undefined, geocoder;

      function insertPin(course) {
          var address = course.address;
          var organization = course.organization;

          geocoder.geocode(
              {'address': address},
              function (results, status) {
                  if (status == google.maps.GeocoderStatus.OK) {
                      var marker = new google.maps.Marker({
                          map: map,
                          position: results[0].geometry.location,
                          title: organization
                      });
                      google.maps.event.addListener(marker, 'click', function() {
                          showPopup(address);
                      });
                  } else {
                      console.error("Geocoding failed: " + status);
                  }
              });
      }

      // Load and run a script.
      function load(url) {
          var script = document.createElement('script');
          script.setAttribute('src', url);
          script.setAttribute('id', 'jsonScript');
          script.setAttribute('type', 'text/javascript');
          document.documentElement.firstChild.appendChild(script);
      }

      function initialize() {
          // Create the map.
          map = new google.maps.Map(document.getElementById("map-canvas"), {
              center: new google.maps.LatLng(36.16, 273.215),
              zoom: 12,
              mapTypeId: google.maps.MapTypeId.ROADMAP
          });
          geocoder = new google.maps.Geocoder();

          startDataLoad();
      }

      function updateMap() {
          // // Create the list of matching courses, grouped by location.
          // var locations = [];
          // for (var i = 0; i < courses.length; i++) {
          //     var course = courses[i];
          // 
          //     // Have we already got a matching course at this location?
          //     var found = false;
          //     for (var j = 0; j < locations.length; i++) {
          //         if (course.locationName == locations[j][0].locationName) {
          //             // Yes, so add this course to the other course we already found.
          //             locations[j].push(course);
          //             found = true;
          //             break;
          //         }
          //     }
          //     if (!found) {
          //         // No, so make a new location group with just this course in it.
          //         locations.push([course]);
          //     }
          // }
          for (var i = 0; i < courses.length; i++)
              insertPin(courses[i]);
      }

      google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <div id="detail-popup">
      <div class="hide" onclick="hidePopup()">x</div>
      <div class="organization" data-bind="text: organization"></div>
      <div class="address" data-bind="text: address"></div>
      <table>
        <thead>
          <tr>
            <th>Class</th>
            <th>Date</th>
            <th>Fee</th>
          </tr>
        </thead>
        <tbody data-bind="foreach: coursesAtLocation">
          <tr>
            <td class="level" data-bind="text: level"></td>
            <td class="startDate" data-bind="text: startDate"></td>
            <td class="fee" data-bind="text: fee"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </body>
</html>
